{{! When this is a new fragment, but not the last fragment,
then we use the following *ClosedAtStart tags to close any
formatting that may be open for the previous fragment. }}
{{#fragmentIsBoldClosedAtStart}}</b>{{/fragmentIsBoldClosedAtStart}}
{{#fragmentIsItalicizedClosedAtStart}}</i>{{/fragmentIsItalicizedClosedAtStart}}
{{#fragmentIsMonospaceClosedAtStart}}</tt>{{/fragmentIsMonospaceClosedAtStart}}
{{#fragmentIsStruckthroughClosedAtStart}}</del>{{/fragmentIsStruckthroughClosedAtStart}}
{{#fragmentIsUnderlinedClosedAtStart}}</u>{{/fragmentIsUnderlinedClosedAtStart}}
{{#fragmentTextColorClosedAtStart}}
</span>
{{/fragmentTextColorClosedAtStart}}

{{#fragmentTextColorOpened}}
<span class="effect"
    {{#fragmentTextColorUsesStyleTag}}
        style="
            {{#fragmentForegroundColorIsSet}}
                color: {{fragmentForegroundColor}};
            {{/fragmentForegroundColorIsSet}}

            {{#fragmentBackgroundColorIsSet}}
                background-color: {{fragmentBackgroundColor}};
            {{/fragmentBackgroundColorIsSet}}
        "
    {{^fragmentTextColorUsesStyleTag}}
        {{#fragmentForegroundColorIsSet}}
            color-number="{{fragmentForegroundColor}}"
        {{/fragmentForegroundColorIsSet}}

        {{#fragmentBackgroundColorIsSet}}
            bgcolor-number="{{fragmentBackgroundColor}}"
        {{/fragmentBackgroundColorIsSet}}
    {{/fragmentTextColorUsesStyleTag}}
>
{{/fragmentTextColorOpened}}
{{#fragmentIsBoldOpened}}<b>{{/fragmentIsBoldOpened}}
{{#fragmentIsItalicizedOpened}}<i>{{/fragmentIsItalicizedOpened}}
{{#fragmentIsMonospaceOpened}}<tt>{{/fragmentIsMonospaceOpened}}
{{#fragmentIsStruckthroughOpened}}<del>{{/fragmentIsStruckthroughOpened}}
{{#fragmentIsUnderlinedOpened}}<u>{{/fragmentIsUnderlinedOpened}}

{{#inlineNicknameMatchFound}}
<span class="inline_nickname" ondblclick="Textual.inlineNicknameDoubleClicked()" oncontextmenu="Textual.openInlineNicknameContextualMenu()" mode="{{inlineNicknameUserModeSymbol}}"
    {{#nicknameColorHashingIsStyleBased}}
        {{#nicknameColorStyleOverride}}
            coloroverride="true"
        {{/nicknameColorStyleOverride}}

        {{^ isEmpty(inlineNicknameColorStyle) }}
        style="color: {{inlineNicknameColorStyle}};"
        {{/ isEmpty(inlineNicknameColorStyle) }}
    {{^nicknameColorHashingIsStyleBased}}
        colornumber="{{inlineNicknameColorNumber}}"
    {{/nicknameColorHashingIsStyleBased}}>{{inlineNicknameUserModeSymbol}}
{{/inlineNicknameMatchFound}}
{{{messageFragment}}}
{{#inlineNicknameMatchFound}}
</span>
{{/inlineNicknameMatchFound}}

{{! When this is the end of the last fragment, we terminate all }}
{{#fragmentIsBoldClosedAtEnd}}</b>{{/fragmentIsBoldClosedAtEnd}}
{{#fragmentIsItalicizedClosedAtEnd}}</i>{{/fragmentIsItalicizedClosedAtEnd}}
{{#fragmentIsMonospaceClosedAtEnd}}</tt>{{/fragmentIsMonospaceClosedAtEnd}}
{{#fragmentIsStruckthroughClosedAtEnd}}</del>{{/fragmentIsStruckthroughClosedAtEnd}}
{{#fragmentIsUnderlinedClosedAtEnd}}</u>{{/fragmentIsUnderlinedClosedAtEnd}}
{{#fragmentTextColorClosedAtEnd}}
</span>
{{/fragmentTextColorClosedAtEnd}}
